<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock: {{ ticker }} - Arthos</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/arthos-favicon.svg">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            padding: 20px 0;
        }
        .header h1 {
            color: #4285f4;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .metrics-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-item {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .metric-item:last-child {
            border-bottom: none;
        }
        .metric-label {
            font-weight: 600;
            color: #666;
        }
        .metric-value {
            font-size: 1.2em;
            color: #333;
        }
        .trading-range-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }
        .trading-range-current {
            font-size: 0.9em;
            font-weight: 600;
            color: #333;
        }
        .trading-range-bar {
            position: relative;
            height: 28px;
            background: linear-gradient(to right, 
                rgba(60, 179, 113, 0.3) 0%, 
                rgba(60, 179, 113, 0.3) 16.67%,
                rgba(144, 238, 144, 0.3) 16.67%,
                rgba(144, 238, 144, 0.3) 33.33%,
                rgba(150, 150, 150, 0.15) 33.33%,
                rgba(150, 150, 150, 0.15) 66.67%,
                rgba(255, 182, 193, 0.3) 66.67%,
                rgba(255, 182, 193, 0.3) 83.33%,
                rgba(220, 20, 60, 0.3) 83.33%,
                rgba(220, 20, 60, 0.3) 100%);
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: visible;
        }
        .trading-range-dma-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #000;
            z-index: 1;
        }
        .trading-range-dot {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
            z-index: 3;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }
        .trading-range-tail {
            position: absolute;
            top: 50%;
            height: 1px;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 1;
            transform: translateY(-50%);
        }
        .trading-range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: #666;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header mb-4">
            <a href="/" class="text-decoration-none text-primary mb-2 d-inline-block">← Back to Home</a>
            <h1>{{ ticker }} - Stock Details</h1>
        </div>
        
        <div class="row">
            <div class="col-lg-9">
                <div class="chart-container">
                    <h5 class="mb-3">Price Chart (Past 365 Days)</h5>
                    <div id="stockChart" style="height: 600px;"></div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="metrics-card">
                    <h5 class="mb-3">Current Metrics</h5>
                    <div class="metric-item">
                        <div class="metric-label">Current Price</div>
                        <div class="metric-value">${{ "%.2f"|format(metrics.current_price) }}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">SMA 50</div>
                        <div class="metric-value">${{ "%.2f"|format(metrics.sma_50) }}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">SMA 200</div>
                        <div class="metric-value">${{ "%.2f"|format(metrics.sma_200) }}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Trading Range</div>
                        <div class="metric-value">
                            {% set dot_position = (50 + (metrics.devstep / 3) * 50) %}
                            {% if dot_position < 0 %}
                                {% set dot_position = 0 %}
                            {% elif dot_position > 100 %}
                                {% set dot_position = 100 %}
                            {% endif %}
                            {% set dot_color = "#28a745" if metrics.devstep < -1 else ("#6c757d" if metrics.devstep <= 1 else "#dc3545") %}
                            <div class="trading-range-container">
                                <div class="trading-range-current">
                                    {% if metrics.signal == "Extreme Oversold" %}
                                        <span class="badge bg-success">Extreme OS</span>
                                    {% elif metrics.signal == "Oversold" %}
                                        <span class="badge bg-info text-dark">Oversold</span>
                                    {% elif metrics.signal == "Neutral" %}
                                        <span class="badge bg-secondary">Neutral</span>
                                    {% elif metrics.signal == "Overbought" %}
                                        <span class="badge bg-warning text-dark">Overbought</span>
                                    {% elif metrics.signal == "Extreme Overbought" %}
                                        <span class="badge bg-danger">Extreme OB</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ metrics.signal }}</span>
                                    {% endif %}
                                </div>
                                <div class="trading-range-bar">
                                    <div class="trading-range-dma-line"></div>
                                    {% if dot_position != 50 %}
                                        {% if dot_position < 50 %}
                                            <div class="trading-range-tail" style="left: {{ dot_position|round(1) }}%; width: {{ (50 - dot_position)|round(1) }}%;"></div>
                                        {% else %}
                                            <div class="trading-range-tail" style="left: 50%; width: {{ (dot_position - 50)|round(1) }}%;"></div>
                                        {% endif %}
                                    {% endif %}
                                    <div class="trading-range-dot" style="left: {{ dot_position|round(1) }}%; background-color: {{ dot_color }};"></div>
                                </div>
                                <div class="trading-range-labels">
                                    <span>OS</span>
                                    <span>50-DMA</span>
                                    <span>OB</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <script>
        // Prepare chart data
        const candlestickData = {{ chart_data.candlestick_data | tojson }};
        const sma50Data = {{ chart_data.sma_50 | tojson }};
        const sma200Data = {{ chart_data.sma_200 | tojson }};
        const stdBands = {{ chart_data.std_bands | tojson }};
        
        // Extract STD band data for area charts
        const std3Upper = stdBands.std_3_upper.map(d => d.y);
        const std3Lower = stdBands.std_3_lower.map(d => d.y);
        const std2Upper = stdBands.std_2_upper.map(d => d.y);
        const std2Lower = stdBands.std_2_lower.map(d => d.y);
        const std1Upper = stdBands.std_1_upper.map(d => d.y);
        const std1Lower = stdBands.std_1_lower.map(d => d.y);
        
        // Create SMA 200 trace (background line)
        const sma200Trace = {
            x: sma200Data.map(d => d.x),
            y: sma200Data.map(d => d.y),
            type: 'scatter',
            mode: 'lines',
            name: '200-day SMA',
            line: {
                color: '#2196f3',
                width: 2
            }
        };
        
        // Create SMA 50 trace (foreground line)
        const sma50Trace = {
            x: sma50Data.map(d => d.x),
            y: sma50Data.map(d => d.y),
            type: 'scatter',
            mode: 'lines',
            name: '50-day SMA',
            line: {
                color: '#ff9800',
                width: 2
            }
        };
        
        // Create candlestick trace (foreground)
        const candlestickTrace = {
            x: candlestickData.map(d => d.x),
            open: candlestickData.map(d => d.open),
            high: candlestickData.map(d => d.high),
            low: candlestickData.map(d => d.low),
            close: candlestickData.map(d => d.close),
            type: 'candlestick',
            name: 'Price',
            increasing: {line: {color: '#26a69a'}},
            decreasing: {line: {color: '#ef5350'}}
        };
        
        // Order matters: background layers first, then foreground
        // We need to create proper area fills by pairing upper and lower bounds
        // For Plotly area charts, we need to combine upper and lower in a single trace
        const dates = stdBands.std_2_upper.map(d => d.x);
        
        // +2 SD to +3 SD band area (darker red - extreme overbought/rich)
        const stdPos3AreaTrace = {
            x: dates.concat(dates.slice().reverse()),
            y: std3Upper.concat(std2Upper.slice().reverse()),
            type: 'scatter',
            mode: 'lines',
            name: '+2 to +3 STD',
            fill: 'toself',
            fillcolor: 'rgba(220, 20, 60, 0.3)',
            line: {color: 'transparent'},
            showlegend: false,
            hoverinfo: 'skip'
        };
        
        // -2 SD to -3 SD band area (light green - extreme oversold/cheap)
        const stdNeg3AreaTrace = {
            x: dates.concat(dates.slice().reverse()),
            y: std2Lower.concat(std3Lower.slice().reverse()),
            type: 'scatter',
            mode: 'lines',
            name: '-2 to -3 STD',
            fill: 'toself',
            fillcolor: 'rgba(144, 238, 144, 0.3)',
            line: {color: 'transparent'},
            showlegend: false,
            hoverinfo: 'skip'
        };
        
        // +1 SD to +2 SD band area (light red/pink - moderate overbought/rich)
        const stdPosAreaTrace = {
            x: dates.concat(dates.slice().reverse()),
            y: std2Upper.concat(std1Upper.slice().reverse()),
            type: 'scatter',
            mode: 'lines',
            name: '+1 to +2 STD',
            fill: 'toself',
            fillcolor: 'rgba(255, 182, 193, 0.3)',
            line: {color: 'transparent'},
            showlegend: false,
            hoverinfo: 'skip'
        };
        
        // -1 SD to -2 SD band area (slightly darker green - moderate oversold/cheap)
        const stdNegAreaTrace = {
            x: dates.concat(dates.slice().reverse()),
            y: std1Lower.concat(std2Lower.slice().reverse()),
            type: 'scatter',
            mode: 'lines',
            name: '-1 to -2 STD',
            fill: 'toself',
            fillcolor: 'rgba(60, 179, 113, 0.3)',
            line: {color: 'transparent'},
            showlegend: false,
            hoverinfo: 'skip'
        };
        
        // -1 SD to +1 SD band area (gray - neutral zone)
        const std1AreaTrace = {
            x: dates.concat(dates.slice().reverse()),
            y: std1Upper.concat(std1Lower.slice().reverse()),
            type: 'scatter',
            mode: 'lines',
            name: '±1 STD',
            fill: 'toself',
            fillcolor: 'rgba(150, 150, 150, 0.15)',
            line: {color: 'transparent'},
            showlegend: false,
            hoverinfo: 'skip'
        };
        
        const data = [stdPos3AreaTrace, stdNeg3AreaTrace, stdPosAreaTrace, stdNegAreaTrace, std1AreaTrace, sma200Trace, sma50Trace, candlestickTrace];
        
        const layout = {
            title: {
                text: '{{ ticker }} - Stock Price Chart',
                font: {
                    size: 20
                }
            },
            xaxis: {
                title: 'Date',
                type: 'date',
                rangeslider: {
                    visible: false
                }
            },
            yaxis: {
                title: 'Price ($)'
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                orientation: 'h',
                x: 0.5,
                xanchor: 'center',
                y: -0.15,
                yanchor: 'top',
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                tracegroupgap: 30
            },
            plot_bgcolor: 'white',
            paper_bgcolor: 'white'
        };
        
        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false
        };
        
        Plotly.newPlot('stockChart', data, layout, config);
    </script>
</body>
</html>

